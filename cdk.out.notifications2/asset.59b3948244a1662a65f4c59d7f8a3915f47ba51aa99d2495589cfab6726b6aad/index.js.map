{
  "version": 3,
  "sources": ["../../backend/services/api/notifications/unsubscribe.ts"],
  "sourcesContent": ["/**\n * DELETE /api/v1/notifications/subscribe/{subscriptionId}\n * \n * Unsubscribe from push notifications\n * Soft deletes the subscription (sets isActive = false, isDeleted = true)\n */\n\nimport { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';\nimport { DynamoDBClient } from '@aws-sdk/client-dynamodb';\nimport { DynamoDBDocumentClient, GetCommand, UpdateCommand } from '@aws-sdk/lib-dynamodb';\nimport type { UnsubscribeResponse, PushSubscription } from '../../types/notification.types';\n\nconst dynamoClient = new DynamoDBClient({});\nconst docClient = DynamoDBDocumentClient.from(dynamoClient);\n\nconst TABLE_NAME = process.env.TABLE_NAME!;\n\n/**\n * Lambda handler\n */\nexport async function handler(event: APIGatewayProxyEvent): Promise<APIGatewayProxyResult> {\n  console.log('Unsubscribe from notifications:', JSON.stringify(event, null, 2));\n\n  try {\n    // Get user from JWT (added by authorizer)\n    const userId = event.requestContext.authorizer?.claims?.sub;\n    if (!userId) {\n      return {\n        statusCode: 401,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ success: false, message: 'Unauthorized' }),\n      };\n    }\n\n    // Get subscription ID from path\n    const subscriptionId = event.pathParameters?.subscriptionId;\n    if (!subscriptionId) {\n      return {\n        statusCode: 400,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ \n          success: false, \n          message: 'Missing subscriptionId in path' \n        }),\n      };\n    }\n\n    // Get subscription to verify ownership\n    const result = await docClient.send(new GetCommand({\n      TableName: TABLE_NAME,\n      Key: {\n        pk: `USER#${userId}`,\n        sk: `PUSH_SUB#${subscriptionId}`,\n      },\n    }));\n\n    const subscription = result.Item as PushSubscription | undefined;\n\n    if (!subscription) {\n      return {\n        statusCode: 404,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ \n          success: false, \n          message: 'Subscription not found' \n        }),\n      };\n    }\n\n    // Verify ownership (subscription's userId must match JWT userId)\n    if (subscription.userId !== userId) {\n      return {\n        statusCode: 403,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ \n          success: false, \n          message: 'Forbidden: You do not own this subscription' \n        }),\n      };\n    }\n\n    // Soft delete: Set isActive = false, isDeleted = true\n    const now = new Date().toISOString();\n\n    await docClient.send(new UpdateCommand({\n      TableName: TABLE_NAME,\n      Key: {\n        pk: `USER#${userId}`,\n        sk: `PUSH_SUB#${subscriptionId}`,\n      },\n      UpdateExpression: `\n        SET isActive = :inactive,\n            isDeleted = :deleted,\n            deletedAt = :now,\n            updatedAt = :now,\n            gsi5pk = :gsi5pk\n      `,\n      ExpressionAttributeValues: {\n        ':inactive': false,\n        ':deleted': true,\n        ':now': now,\n        ':gsi5pk': 'PUSH_SUB_INACTIVE',\n      },\n    }));\n\n    console.log(`Unsubscribed: ${subscriptionId} for user ${userId}`);\n\n    return {\n      statusCode: 200,\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        success: true,\n        message: 'Successfully unsubscribed from push notifications',\n      } as UnsubscribeResponse),\n    };\n\n  } catch (error) {\n    console.error('Error unsubscribing from notifications:', error);\n    return {\n      statusCode: 500,\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ \n        success: false, \n        message: 'Internal server error' \n      }),\n    };\n  }\n}\n\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAQA,IAAAI,EAA+B,oCAC/BC,EAAkE,iCAG5DC,EAAe,IAAI,iBAAe,CAAC,CAAC,EACpCC,EAAY,yBAAuB,KAAKD,CAAY,EAEpDE,EAAa,QAAQ,IAAI,WAK/B,eAAsBN,EAAQO,EAA6D,CACzF,QAAQ,IAAI,kCAAmC,KAAK,UAAUA,EAAO,KAAM,CAAC,CAAC,EAE7E,GAAI,CAEF,IAAMC,EAASD,EAAM,eAAe,YAAY,QAAQ,IACxD,GAAI,CAACC,EACH,MAAO,CACL,WAAY,IACZ,QAAS,CAAE,eAAgB,kBAAmB,EAC9C,KAAM,KAAK,UAAU,CAAE,QAAS,GAAO,QAAS,cAAe,CAAC,CAClE,EAIF,IAAMC,EAAiBF,EAAM,gBAAgB,eAC7C,GAAI,CAACE,EACH,MAAO,CACL,WAAY,IACZ,QAAS,CAAE,eAAgB,kBAAmB,EAC9C,KAAM,KAAK,UAAU,CACnB,QAAS,GACT,QAAS,gCACX,CAAC,CACH,EAYF,IAAMC,GARS,MAAML,EAAU,KAAK,IAAI,aAAW,CACjD,UAAWC,EACX,IAAK,CACH,GAAI,QAAQE,CAAM,GAClB,GAAI,YAAYC,CAAc,EAChC,CACF,CAAC,CAAC,GAE0B,KAE5B,GAAI,CAACC,EACH,MAAO,CACL,WAAY,IACZ,QAAS,CAAE,eAAgB,kBAAmB,EAC9C,KAAM,KAAK,UAAU,CACnB,QAAS,GACT,QAAS,wBACX,CAAC,CACH,EAIF,GAAIA,EAAa,SAAWF,EAC1B,MAAO,CACL,WAAY,IACZ,QAAS,CAAE,eAAgB,kBAAmB,EAC9C,KAAM,KAAK,UAAU,CACnB,QAAS,GACT,QAAS,6CACX,CAAC,CACH,EAIF,IAAMG,EAAM,IAAI,KAAK,EAAE,YAAY,EAEnC,aAAMN,EAAU,KAAK,IAAI,gBAAc,CACrC,UAAWC,EACX,IAAK,CACH,GAAI,QAAQE,CAAM,GAClB,GAAI,YAAYC,CAAc,EAChC,EACA,iBAAkB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAOlB,0BAA2B,CACzB,YAAa,GACb,WAAY,GACZ,OAAQE,EACR,UAAW,mBACb,CACF,CAAC,CAAC,EAEF,QAAQ,IAAI,iBAAiBF,CAAc,aAAaD,CAAM,EAAE,EAEzD,CACL,WAAY,IACZ,QAAS,CAAE,eAAgB,kBAAmB,EAC9C,KAAM,KAAK,UAAU,CACnB,QAAS,GACT,QAAS,mDACX,CAAwB,CAC1B,CAEF,OAASI,EAAO,CACd,eAAQ,MAAM,0CAA2CA,CAAK,EACvD,CACL,WAAY,IACZ,QAAS,CAAE,eAAgB,kBAAmB,EAC9C,KAAM,KAAK,UAAU,CACnB,QAAS,GACT,QAAS,uBACX,CAAC,CACH,CACF,CACF",
  "names": ["unsubscribe_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "dynamoClient", "docClient", "TABLE_NAME", "event", "userId", "subscriptionId", "subscription", "now", "error"]
}
